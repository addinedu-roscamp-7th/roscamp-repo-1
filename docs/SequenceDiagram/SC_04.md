@startuml
title Pickee 복귀 및 충전 프로세스

participant "Shopee\nMain Service" as main
participant "DB Manager" as db
participant "Pickee\nMain Controller" as pickee_main
participant "Pickee\nMobile Controller" as pickee_mobile

activate pickee_main

pickee_main -> main: [ROS2 Topic] 장바구니 교체 완료\n(/pickee/cart_handover_complete)
activate main

main -> main: 복귀 지시\n여부 판단
activate main #DarkSalmon
deactivate main

main -> pickee_main: [ROS2 Service] 복귀 명령\n(/pickee/workflow/return_to_base)

pickee_main --> main: [ROS2 Service] 복귀 명령 응답\n(/pickee/workflow/return_to_base)
deactivate main

' Coordinate request sequence from new XML
pickee_main -> main: [ROS2 Service] 목적지 좌표 요청\n(/main/get_location_pose)
activate main
main -> db: 복귀장소 좌표 요청
activate db
db --> main: 복귀장소 좌표 반환
deactivate db
main --> pickee_main: [ROS2 Service] 목적지 좌표 응답\n(/main/get_location_pose)
deactivate main

pickee_main -> pickee_main: Global Path\n계획
activate pickee_main #DarkSalmon
deactivate pickee_main

pickee_main -> pickee_main: Pickee 상태 변경\n(MOVING_TO_STANDBY->CHARGING_UNAVAILABLE)
activate pickee_main #DarkSalmon
deactivate pickee_main

pickee_main -> pickee_mobile: [ROS2 Service] 목적지 이동 명령\n(/pickee/mobile/move_to_location)
activate pickee_mobile

pickee_mobile --> pickee_main: [ROS2 Service] 목적지 이동 명령 응답\n(/pickee/mobile/move_to_location)

pickee_mobile -> pickee_mobile: 경로 주행
activate pickee_mobile #DarkSalmon
deactivate pickee_mobile

pickee_mobile -> pickee_main: [ROS2 Topic] 도착 알림\n(/pickee/mobile/arrival)
deactivate pickee_mobile

pickee_main -> main: [ROS2 Topic] 도착 보고\n(/pickee/arrival_notice)

group 충전 프로세스
    loop 배터리 < 100%
        pickee_main -> pickee_main: 충전
        activate pickee_main #DarkSalmon
        deactivate pickee_main

        pickee_main -> pickee_main: 배터리 체크
        activate pickee_main #DarkSalmon
        deactivate pickee_main
    end

    pickee_main -> pickee_main: Pickee 상태 변경\n(CHARGING_UNAVAILABLE->CHARGING_AVAILABLE)
    activate pickee_main #DarkSalmon
    deactivate pickee_main
end

deactivate pickee_main

@enduml