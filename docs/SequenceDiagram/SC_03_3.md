@startuml
title Packee 작업 가능 확인 및 장바구니 인식 프로세스

participant "Shopee\nMain Service" as Shopee
participant "DB Manager" as DB
participant "Pickee\nMain Controller" as Pickee
participant "Packee\nMain Controller" as PackeeCtrl
participant "Packee\nVision AI Service" as Vision
participant "Packee\nArm Controller" as ArmCtrl

activate Shopee

Pickee -> Shopee: [ROS2 Topic] 장바구니 교체 완료\n(/pickee/cart_handover_complete)

Shopee -> PackeeCtrl: [ROS2 Service] 작업 가능 확인 요청\n(/packee/packing/check_availability)
activate PackeeCtrl

PackeeCtrl --> Shopee: [ROS2 Service] 작업 가능 확인 요청 응답\n(/packee/packing/check_availability)

PackeeCtrl -> ArmCtrl: [ROS2 Service] 자세 변경 명령\n(/packee/arm/move_to_pose, pose_type=cart_view)
activate ArmCtrl

ArmCtrl -> ArmCtrl: 장바구니 확인 자세\n(cart_view)

ArmCtrl --> PackeeCtrl: [ROS2 Service] 자세 변경 응답\n(/packee/arm/move_to_pose, pose_type=cart_view)

ArmCtrl -> PackeeCtrl: [ROS2 Topic] 자세 변경 상태\n(/packee/arm/pose_status, status=comleted)
deactivate ArmCtrl

loop 장바구니 유무 확인
    PackeeCtrl -> Vision: [ROS2 Service] 장바구니 유무 확인 요청\n(/packee/vision/check_cart_presence)
    activate Vision
    
    Vision -> Vision: 장바구니 유무 확인
    
    Vision --> PackeeCtrl: [ROS2 Service] 장바구니 유무 확인 응답\n(/packee/vision/check_cart_presence)
    deactivate Vision
end

PackeeCtrl -> PackeeCtrl: Packee 상태 변경\n(작업대기 -> 픽업상품인식)

PackeeCtrl -> Shopee: [ROS2 Topic] 작업 가능 확인 완료\n(/packee/availability_result)

deactivate PackeeCtrl
deactivate Shopee

@enduml