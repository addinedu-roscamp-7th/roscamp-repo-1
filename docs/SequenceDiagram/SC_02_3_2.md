@startuml SC_02_3_2_수동선택
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceMessageAlign center

actor User as user
participant "Shopee App" as app
participant "Shopee\nMain Service" as main
participant "Shopee\nLLM Service" as llm
participant "Pickee\nMain Controller" as pickee_main
participant "Pickee\nVision AI Service" as vision
participant "Pickee\nArm Controller" as pickee_arm

pickee_main -> main: 매대 도착 보고\n(Location ID)

main -> pickee_main: 상품 위치 인식 요청
activate pickee_main

pickee_main -> pickee_arm: 매대 확인 자세 요청\n(자세 타입)
activate pickee_arm

pickee_arm -> pickee_arm: 매대 확인 자세\n실행
activate pickee_arm #DarkSalmon
deactivate pickee_arm

pickee_arm --> pickee_main: 매대 확인 자세 완료
deactivate pickee_arm

pickee_main -> vision: 상품 위치 확인 요청 (상품 ID)
activate vision

vision -> vision: 상품 위치 인식
activate vision #DarkSalmon
deactivate vision

vision -> vision: 송출중인 영상에\nbbox 그리기
activate vision #DarkSalmon
deactivate vision

vision --> pickee_main: 상품 위치\n(상품 ID, bbox 번호, bbox 좌표, score)
deactivate vision

pickee_main --> main: 상품 위치 인식 완료\n(상품 ID, bbox 번호, bbox 좌표, score)
deactivate pickee_main

main -> app: [TCP] 상품 선택 시작 알림\n(product_selection_start)
activate app

app -> app: 상품 선택\n화면 전환
activate app #DarkSalmon
deactivate app

alt 음성
    user -> app: 음성\n(1번 오렌지 담아줘)
    
    app -> app: 음성 명령어\n텍스트 변환
    activate app #DarkSalmon
    deactivate app
    
    app -> main: 텍스트 명령어 전달
    activate main
    
    main -> llm: 명령어 분석 요청\n(발화의도, 텍스트 명령어)
    activate llm
    
    llm -> llm: 명령어 분석
    activate llm #DarkSalmon
    deactivate llm
    
    llm --> main: 명령어 분석 결과\n(발화의도, bbox번호)
    deactivate llm
    
    deactivate main

else 채팅
    user -> app: 채팅\n(1번 오렌지 담아줘)
    
    app -> main: 텍스트 명령어 전달
    activate main
    
    main -> llm: 명령어 분석 요청\n(발화의도, 텍스트 명령어)
    activate llm
    
    llm -> llm: 명령어 분석
    activate llm #DarkSalmon
    deactivate llm
    
    llm --> main: 명령어 분석 결과\n(발화의도, bbox번호)
    deactivate llm
    
    deactivate main

else bbox 클릭
    user -> app: bbox 클릭
    
    app -> main: bbox 번호 전달
    activate main
    deactivate main
end

deactivate app

@enduml