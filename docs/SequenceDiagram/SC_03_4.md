@startuml
title Packee 포장 프로세스 (Dual-Arm Pick & Place)

participant "Shopee\nMain Service" as Shopee
participant "DB Manager" as DB
participant "Packee\nMain Controller" as PackeeCtrl
participant "Packee\nVision AI Service" as Vision
participant "Packee\nArm Controller" as ArmCtrl

activate Shopee

Shopee -> PackeeCtrl: [ROS2 Service] 포장 시작 명령\n(/packee/start_packing)
activate PackeeCtrl

PackeeCtrl --> Shopee: [ROS2 Service] 포장 시작 명령 응답\n(/packee/start_packing)

== 포장 준비 ==

PackeeCtrl -> ArmCtrl: 장바구니 확인 자세 요청
activate ArmCtrl

ArmCtrl -> ArmCtrl: 장바구니 확인 자세

ArmCtrl --> PackeeCtrl: 장바구니 확인 자세
deactivate ArmCtrl

PackeeCtrl -> Vision: 상품 위치 확인 요청
activate Vision

Vision -> Vision: 상품 위치 확인

Vision --> PackeeCtrl: 상품 위치\n(bbox 좌표, confidence)
deactivate Vision

== 포장 작업 (반복) ==

loop 모든 상품 포장 완료까지
    PackeeCtrl -> PackeeCtrl: 작업 분배 (Task Allocation)\n(Left=상품A, Right=상품B)
    
    PackeeCtrl -> PackeeCtrl: 좌우 팔 스케줄링 (Scheduling)
    
    PackeeCtrl -> PackeeCtrl: 충돌 회피 계획 (Collision-Free Plan)
    
    PackeeCtrl -> ArmCtrl: 좌/우 팔별 Pick/Place 명령 전달\n(bbox, 상품ID)
    activate ArmCtrl
    
    ArmCtrl -> ArmCtrl: Grasp Planning
    
    ArmCtrl -> ArmCtrl: Pick
    
    ArmCtrl -> ArmCtrl: Place
    
    ArmCtrl --> PackeeCtrl: 좌/우 팔 포장 완료\n(성공/실패)
    deactivate ArmCtrl
end

== 포장 완료 처리 ==

PackeeCtrl -> Shopee: [ROS2 Topic] 포장 완료 알림\n(/packee/packing_complete)

Shopee -> DB: 포장 완료 업데이트
activate DB

DB -> DB: 포장 완료\n업데이트

DB --> Shopee: 업데이트 완료
deactivate DB

PackeeCtrl -> ArmCtrl: 대기 자세 요청
activate ArmCtrl

ArmCtrl -> ArmCtrl: 대기 자세

ArmCtrl --> PackeeCtrl: 대기 자세
deactivate ArmCtrl

deactivate PackeeCtrl
deactivate Shopee

@enduml