@startuml
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceMessageAlign center

participant "Shopee\nMain Service" as main
participant "DB Manager" as db
participant "Packee\nMain Controller" as packee_main
participant "Packee\nVision AI Service" as packee_vision
participant "Packee\nArm Controller" as packee_arm

activate main

main -> packee_main: [ROS2 Service] 포장 시작 명령\n(/packee/packing/start)
activate packee_main

packee_main --> main: [ROS2 Service] 포장 시작 명령 응답\n(/packee/packing/start)



loop 모든 상품 포장 완료까지

    packee_main -> packee_arm: [ROS2 Service] 자세 변경 명령\n(/packee/arm/move_to_pose, pose_type=cart_view)
    activate packee_arm

    packee_arm --> packee_main: [ROS2 Service] 자세 변경 명령 응답\n(/packee/arm/move_to_pose)

    packee_arm -> packee_arm: 장바구니 확인 자세\n(pose_type=cart_view)
    activate packee_arm #DarkSalmon
    deactivate packee_arm

    packee_arm -> packee_main: [ROS2 Topic] 자세 변경 상태\n(/packee/arm/pose_status)
    deactivate packee_arm

    packee_main -> packee_vision: [ROS2 Service] 장바구니 내 상품 위치 확인\n(/packee/vision/detect_products_in_cart)
    activate packee_vision

    packee_vision -> packee_vision: 상품 위치 확인
    activate packee_vision #DarkSalmon
    deactivate packee_vision

    packee_vision --> packee_main: [ROS2 Service] 장바구니 내 상품 위치 확인 응답\n(/packee/vision/detect_products_in_cart)
    deactivate packee_vision

    packee_main -> packee_main: Packee 상태 변경\n(DETECTING_PRODUCTS->PLANNING_TASK)

    packee_main -> packee_main: 작업 분배 (Task Allocation)\n(Left=상품A, Right=상품B)
    activate packee_main #DarkSalmon
    deactivate packee_main

    packee_main -> packee_main: 좌우 팔 스케줄링 (Scheduling)
    activate packee_main #DarkSalmon
    deactivate packee_main

    packee_main -> packee_main: 충돌 회피 계획 (Collision-Free Plan)
    activate packee_main #DarkSalmon
    deactivate packee_main

    packee_main -> packee_main: Packee 상태 변경\n(PLANNING_TASK->PACKING_PRODUCTS)

    packee_main -> packee_arm: [ROS2 Service] 상품 픽업 명령\n(/packee/arm/pick_product)
    activate packee_arm

    packee_arm --> packee_main: [ROS2 Service] 상품 픽업 명령 응답\n(/packee/arm/pick_product)

    packee_arm -> packee_arm: Grasp Planning
    activate packee_arm #DarkSalmon
    deactivate packee_arm

    packee_arm -> packee_arm: Pick
    activate packee_arm #DarkSalmon
    deactivate packee_arm

    packee_arm -> packee_main: [ROS2 Topic] 픽업 상태\n(/packee/arm/pick_status, status=completed)

    deactivate packee_arm

    packee_main -> packee_arm: [ROS2 Service] 상품 담기 명령\n(/packee/arm/place_product)
    activate packee_arm

    packee_arm --> packee_main: [ROS2 Service] 상품 담기 명령 응답\n(/packee/arm/place_product)

    packee_arm -> packee_arm: Place
    activate packee_arm #DarkSalmon
    deactivate packee_arm

    packee_arm -> packee_main: [ROS2 Topic] 담기 상태\n(/packee/arm/place_status, status=completed)
    deactivate packee_arm

end

packee_main -> main: [ROS2 Topic] 포장 완료 알림\n(/packee/packing_complete)

main -> db: 포장 완료 업데이트
activate db

db -> db: 포장 완료\n업데이트
activate db #DarkSalmon
deactivate db

db --> main: 업데이트 완료
deactivate db

packee_main -> packee_arm: [ROS2 Service] 자세 변경 명령\n(/packee/arm/move_to_pose, pose_type=standby)
activate packee_arm

packee_arm --> packee_main: [ROS2 Service] 자세 변경 명령 응답\n(/packee/arm/move_to_pose)

packee_arm -> packee_arm: 대기 자세\n(pose_type=standby)
activate packee_arm #DarkSalmon
deactivate packee_arm

packee_arm -> packee_main: [ROS2 Topic] 자세 변경 상태\n(/packee/arm/pose_status, status=completed)
deactivate packee_arm

packee_main -> packee_main: Packee 상태 변경\n(PACKING_PRODUCTS->STANDBY)

deactivate packee_main
deactivate main

@enduml