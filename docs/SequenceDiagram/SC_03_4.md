@startuml
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceMessageAlign center

participant "Shopee\nMain Service" as Shopee
participant "DB Manager" as DB
participant "Packee\nMain Controller" as PackeeCtrl
participant "Packee\nVision AI Service" as Vision
participant "Packee\nArm Controller" as ArmCtrl

activate Shopee

Shopee -> PackeeCtrl: [ROS2 Service] 포장 시작 명령\n(/packee/packing/start)
activate PackeeCtrl

PackeeCtrl --> Shopee: [ROS2 Service] 포장 시작 명령 응답\n(/packee/packing/start)

loop 모든 상품 포장 완료까지
    
    PackeeCtrl -> ArmCtrl: [ROS2 Service] 자세 변경 명령\n(/packee/arm/move_to_pose, pose_type=cart_view)
    activate ArmCtrl
    
    ArmCtrl --> PackeeCtrl: [ROS2 Service] 자세 변경 명령 응답\n(/packee/arm/move_to_pose)
    
    ArmCtrl -> ArmCtrl: 장바구니 확인 자세\n(pose_type=cart_view)
    activate ArmCtrl #DarkSalmon
    deactivate ArmCtrl
    
    ArmCtrl -> PackeeCtrl: [ROS2 Topic] 자세 변경 상태\n(/packee/arm/pose_status)
    deactivate ArmCtrl
    
    PackeeCtrl -> Vision: [ROS2 Service] 장바구니 내 상품 위치 확인\n(/packee/vision/detect_products_in_cart)
    activate Vision
    
    Vision -> Vision: 상품 위치 확인
    activate Vision #DarkSalmon
    deactivate Vision
    
    Vision --> PackeeCtrl: [ROS2 Service] 장바구니 내 상품 위치 확인 응답\n(/packee/vision/detect_products_in_cart)
    deactivate Vision
    
    PackeeCtrl -> PackeeCtrl: 작업 분배 (Task Allocation)\n(Left=상품A, Right=상품B)
    activate PackeeCtrl #DarkSalmon
    deactivate PackeeCtrl
    
    PackeeCtrl -> PackeeCtrl: 좌우 팔 스케줄링 (Scheduling)
    activate PackeeCtrl #DarkSalmon
    deactivate PackeeCtrl
    
    PackeeCtrl -> PackeeCtrl: 충돌 회피 계획 (Collision-Free Plan)
    activate PackeeCtrl #DarkSalmon
    deactivate PackeeCtrl
    
    PackeeCtrl -> ArmCtrl: [ROS2 Service] 상품 픽업 명령\n(/packee/arm/pick_product)
    activate ArmCtrl
    
    ArmCtrl --> PackeeCtrl: [ROS2 Service] 상품 픽업 명령 응답\n(/packee/arm/pick_product)
    
    ArmCtrl -> ArmCtrl: Grasp Planning
    activate ArmCtrl #DarkSalmon
    deactivate ArmCtrl
    
    ArmCtrl -> ArmCtrl: Pick
    activate ArmCtrl #DarkSalmon
    deactivate ArmCtrl
    
    ArmCtrl -> PackeeCtrl: [ROS2 Topic] 픽업 상태\n(/packee/arm/pick_status, status=completed)
    
    deactivate ArmCtrl
    
    PackeeCtrl -> ArmCtrl: [ROS2 Service] 상품 담기 명령\n(/packee/arm/place_product)
    activate ArmCtrl
    
    ArmCtrl --> PackeeCtrl: [ROS2 Service] 상품 담기 명령 응답\n(/packee/arm/place_product)
    
    ArmCtrl -> ArmCtrl: Place
    activate ArmCtrl #DarkSalmon
    deactivate ArmCtrl
    
    ArmCtrl -> PackeeCtrl: [ROS2 Topic] 담기 상태\n(/packee/arm/place_status, status=completed)
    deactivate ArmCtrl
    
end

PackeeCtrl -> Shopee: [ROS2 Topic] 포장 완료 알림\n(/packee/packing_complete)

Shopee -> DB: 포장 완료 업데이트
activate DB

DB -> DB: 포장 완료\n업데이트
activate DB #DarkSalmon
deactivate DB

DB --> Shopee: 업데이트 완료
deactivate DB

PackeeCtrl -> ArmCtrl: [ROS2 Service] 자세 변경 명령\n(/packee/arm/move_to_pose, pose_type=standby)
activate ArmCtrl

ArmCtrl --> PackeeCtrl: [ROS2 Service] 자세 변경 명령 응답\n(/packee/arm/move_to_pose)

ArmCtrl -> ArmCtrl: 대기 자세\n(pose_type=standby)
activate ArmCtrl #DarkSalmon
deactivate ArmCtrl

ArmCtrl -> PackeeCtrl: [ROS2 Topic] 자세 변경 상태\n(/packee/arm/pose_status, status=completed)
deactivate ArmCtrl

deactivate PackeeCtrl
deactivate Shopee

@enduml