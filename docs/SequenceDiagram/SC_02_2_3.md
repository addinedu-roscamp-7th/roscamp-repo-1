# SC_02_2_3 - Pickee 주행 알고리즘 집중화 시퀀스

@startuml SC_02_2_3_Centralized_Path_Planning
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceMessageAlign center

participant "Pickee\nVision AI Service" as vision
participant "Pickee\nMain Controller" as pickee_main  
participant "Pickee\nMobile Controller" as pickee_mobile

title 주행 알고리즘 집중화 - 장애물 감지 및 통합 처리

== 초기 이동 명령 ==
pickee_main -> pickee_mobile: [ROS2 Service] 목적지 이동 명령\n(/pickee/mobile/move_to_location)\n+ target_pose only
activate pickee_mobile

pickee_mobile -> pickee_mobile: Global Path 자동 생성\n(A* 알고리즘)
activate pickee_mobile #LightGreen
deactivate pickee_mobile

pickee_mobile --> pickee_main: [ROS2 Service] 이동 시작 응답
pickee_mobile -> pickee_mobile: 기본 경로 주행 시작
activate pickee_mobile #LightBlue

== 장애물 감지 및 통합 처리 ==
loop 실시간 주행 중
    vision -> vision: 장애물 인식
    activate vision
    activate vision #DarkSalmon
    deactivate vision
    
    vision -> vision: 장애물 분류\n(타입, 위치, 속도, 거리)
    activate vision #DarkSalmon
    deactivate vision
    
    vision -> pickee_main: [ROS2 Topic] 장애물 감지 알림\n(/pickee/vision/obstacle_detected)
    activate pickee_main
    
    Note over pickee_main: Main은 경로 계산 없이\n정보만 전달
    pickee_main -> pickee_main: 속도 모드 결정\n(decelerate/normal/stop)
    activate pickee_main #DarkSalmon
    deactivate pickee_main
    
    pickee_main -> pickee_mobile: [ROS2 Topic] 장애물 정보 전달\n(/pickee/mobile/speed_control)\n+ obstacles 배열 포함
    
    Note over pickee_mobile: Mobile에서 모든\n경로 계산 수행
    pickee_mobile -> pickee_mobile: 장애물 분석 및 위험도 평가
    activate pickee_mobile #LightGreen
    deactivate pickee_mobile
    
    alt 큰/정적 장애물 (cart, box, shelf)
        pickee_mobile -> pickee_mobile: Global Path 동적 수정\n(우회 경로 생성)
        activate pickee_mobile #Orange
        deactivate pickee_mobile
        
        pickee_mobile -> pickee_mobile: 수정된 Global Path 기반 주행
        activate pickee_mobile #LightBlue
        
    else 작은/동적 장애물 (person, small_object)
        pickee_mobile -> pickee_mobile: Local Path Planning으로 회피
        activate pickee_mobile #Orange
        deactivate pickee_mobile
        
        pickee_mobile -> pickee_mobile: Local 회피 경로 주행
        activate pickee_mobile #LightBlue
        
    else 위험 상황 (distance < 1m)
        pickee_mobile -> pickee_mobile: 긴급 정지 또는 즉시 감속
        activate pickee_mobile #Red
        deactivate pickee_mobile
        deactivate pickee_mobile
        
        pickee_mobile -> pickee_mobile: 안전 확보 후 재시작
        activate pickee_mobile #LightBlue
    end
    
    deactivate pickee_main
    deactivate vision
end

== 목적지 도착 ==
pickee_mobile -> pickee_mobile: 도착 감지
activate pickee_mobile #LightGreen
deactivate pickee_mobile

pickee_mobile -> pickee_main: [ROS2 Topic] 도착 알림\n(/pickee/mobile/arrival)
deactivate pickee_mobile

@enduml

## 핵심 설계 변경점

### 1. **책임 분리 명확화**
- **PickeeMain**: 고수준 워크플로우 관리 + 정보 전달자
- **PickeeMobile**: 모든 주행 알고리즘 집중 처리

### 2. **정보 흐름 간소화**  
- Vision → Main → Mobile (정보만 전달)
- Mobile에서 모든 경로 계산 및 의사결정 수행

### 3. **장애물 처리 통합**
- 장애물 분석, 위험도 평가, 경로 수정을 Mobile 내에서 일괄 처리
- Global Path 동적 수정과 Local Path 회피를 통합 관리

### 4. **실시간 대응 강화**
- 센서 데이터와 Vision 정보를 Mobile에서 직접 처리
- 지연시간 최소화로 안전성 향상

이러한 집중화로 시스템 효율성과 안전성을 동시에 확보할 수 있습니다.