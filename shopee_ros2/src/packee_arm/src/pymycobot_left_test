#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import os
import time
import math
import threading
import numpy as np

import rclpy
from rclpy.node import Node
from rclpy.executors import MultiThreadedExecutor
from rclpy.callback_groups import ReentrantCallbackGroup

from sensor_msgs.msg import JointState
from shopee_interfaces.srv import ArmMoveToPose, ArmPickProduct, PackeeVisionDetectProductsInCart

# -------------------- pymycobot 버전 확인 및 import --------------------
from packaging import version
import pymycobot

MIN_REQUIRE_VERSION = '3.6.6'
current_verison = pymycobot.__version__
print(f'[Packee] pymycobot version: {current_verison}')
if version.parse(current_verison) < version.parse(MIN_REQUIRE_VERSION):
    raise RuntimeError(
        f'The version of pymycobot library must be >= {MIN_REQUIRE_VERSION}. '
        f'Current: {current_verison}. Please upgrade.'
    )

# 통일된 import (mycobot_280 서브모듈/탑레벨 어느 쪽이든 동작하도록 시도)
try:
    from pymycobot.mycobot280 import MyCobot280
except Exception:
    from pymycobot import MyCobot280  # fallback


# -------------------- 그리퍼 라디안→[1..100] 매핑 --------------------
GRIPPER_MIN_DEG = -40.0
GRIPPER_MAX_DEG = 9.0

def map_rad_to_1_100(rad: float) -> int:
    deg = math.degrees(rad)
    t = (deg - GRIPPER_MIN_DEG) / (GRIPPER_MAX_DEG - GRIPPER_MIN_DEG)
    t = max(0.0, min(1.0, t))
    return int(round(1 + t * (100 - 1)))


class PackeeArmController(Node):
    """
    - /packee2/arm/move_to_pose (ArmMoveToPose)
    - /packee2/arm/pick_product (ArmPickProduct)
    - /packee2/vision/detect_products_in_cart (PackeeVisionDetectProductsInCart) 클라이언트
    - joint_states 구독 → 실기 하드웨어로 실시간 동기(팔/그리퍼) (enable_follow 파라미터로 on/off)
    - 서비스 동작(움직임) 중에는 joint_states 팔로우 자동 일시정지(busy)
    """
    def __init__(self):
        super().__init__("Packee_Arm_Controller")

        # -------------------- 파라미터 --------------------
        self.declare_parameter('serial_port', '')
        self.declare_parameter('baud', 1_000_000)
        self.declare_parameter('enable_follow', True)
        self.declare_parameter('follow_speed', 50)   # joint_states 팔로우 속도
        self.declare_parameter('move_speed', 30)     # 서비스 동작 속도

        serial_port = self.get_parameter('serial_port').get_parameter_value().string_value
        baud = self.get_parameter('baud').get_parameter_value().integer_value
        self.enable_follow = self.get_parameter('enable_follow').get_parameter_value().bool_value
        self.follow_speed = int(self.get_parameter('follow_speed').get_parameter_value().integer_value)
        self.speed = int(self.get_parameter('move_speed').get_parameter_value().integer_value)

        # 행동 파라미터
        self.gain = 0.3
        self.epsilon = 10.0  # mm/deg 기준 오차 노름
        self.products = {1: "와사비", 12: "생선", 14: "이클립스"}

        # 콜백 그룹/락
        self.cb_group = ReentrantCallbackGroup()
        self.cmd_lock = threading.RLock()
        self.busy = False  # 서비스 수행 중일 때 True

        # -------------------- 포트 자동 탐색(비어있으면) --------------------
        if not serial_port:
            # 우선순위: /dev/ttyUSB0 → /dev/ttyACM*
            try:
                port_usb0 = os.popen("ls /dev/ttyJETCOBOT>/dev/null").readline().strip()
            except Exception:
                port_usb0 = ''
            try:
                port_acm = os.popen("ls /dev/ttyACM* 2>/dev/null").readline().strip()
            except Exception:
                port_acm = ''
            serial_port = port_usb0 if port_usb0 else (port_acm if port_acm else '/dev/ttyUSB0')

        self.get_logger().info(f"시리얼 포트: {serial_port}, baud: {baud}")

        # -------------------- 하드웨어 연결 --------------------
        self.mc = MyCobot280(serial_port, baud)
        # pymycobot 내부 스레드락 사용(있을 경우)
        try:
            self.mc.thread_lock = True
        except Exception:
            pass

        time.sleep(0.05)
        try:
            if hasattr(self.mc, 'get_fresh_mode') and self.mc.get_fresh_mode() == 0:
                self.mc.set_fresh_mode(1)
                time.sleep(0.05)
        except Exception as e:
            self.get_logger().warn(f"fresh_mode 설정 건너뜀: {e}")

        self.get_logger().info("로봇이 연결되었습니다.")

        # -------------------- 서비스 서버 --------------------
        self.move_to_pose_server = self.create_service(
            ArmMoveToPose,
            "/packee2/arm/move_to_pose",
            self.move_to_arm,
            callback_group=self.cb_group
        )
        self.pickup_server = self.create_service(
            ArmPickProduct,
            "/packee2/arm/pick_product",
            self.pickup_product,
            callback_group=self.cb_group
        )

        # -------------------- 비전 클라이언트 --------------------
        self.vision_client = self.create_client(
            PackeeVisionDetectProductsInCart,
            "/packee2/vision/detect_products_in_cart",
            callback_group=self.cb_group
        )

        # -------------------- joint_states 구독(팔로우) --------------------
        self.rviz_order = [
            'link1_to_link2',
            'link2_to_link3',
            'link3_to_link4',
            'link4_to_link5',
            'link5_to_link6',
            'link6_to_link6_flange',
        ]
        self.gripper_order = ['gripper_controller']

        self.joint_sub = self.create_subscription(
            JointState,
            "joint_states",
            self.joint_states_callback,
            1,
            callback_group=self.cb_group
        )

        self.get_logger().info("서비스/구독 준비 완료")

    # -------------------- 공용: 안전 전송 래퍼 --------------------
    def _send_angles(self, angles_deg: list, speed: int):
        with self.cmd_lock:
            self.mc.send_angles(angles_deg, speed)

    def _set_gripper_value(self, value_1_100: int, speed: int):
        with self.cmd_lock:
            self.mc.set_gripper_value(value_1_100, speed)

    def _send_coords(self, coords_xyzrxryrz: list, speed: int):
        with self.cmd_lock:
            self.mc.send_coords(coords_xyzrxryrz, speed)

    # -------------------- joint_states 팔로우 콜백 --------------------
    def joint_states_callback(self, msg: JointState):
        if not self.enable_follow:
            return
        # 서비스 수행 중에는 팔로우 일시 정지
        if self.busy:
            return

        try:
            joint_state_dict = {name: msg.position[i] for i, name in enumerate(msg.name)}

            # 관절 각도
            data_list = []
            for joint in self.rviz_order:
                if joint in joint_state_dict:
                    rad = joint_state_dict[joint]
                    deg = round(math.degrees(rad), 3)
                    data_list.append(deg)

            if len(data_list) == 6:
                self._send_angles(data_list, self.follow_speed)

            # 그리퍼
            for g in self.gripper_order:
                if g in joint_state_dict:
                    v = map_rad_to_1_100(joint_state_dict[g])
                    self._set_gripper_value(v, self.follow_speed)
                    break

        except Exception as e:
            self.get_logger().warn(f"joint_states 팔로우 중 예외: {e}")

    # -------------------- 비전 호출 --------------------
    def call_vision_service(self, robot_id: int, order_id: int, product_id: int):
        if not self.vision_client.wait_for_service(timeout_sec=2.0):
            self.get_logger().error("비전 서비스 대기 타임아웃")
            return None

        req = PackeeVisionDetectProductsInCart.Request()
        req.robot_id = robot_id
        req.order_id = order_id
        req.expected_product_id = product_id

        future = self.vision_client.call_async(req)

        t0 = time.time()
        while rclpy.ok():
            if future.done():
                self.get_logger().info("비전 응답 수신 완료")
                return future.result()
            if time.time() - t0 > 10.0:
                self.get_logger().error("비전 응답 타임아웃")
                return None
            time.sleep(0.05)

    # -------------------- 서비스: 자세 변경 --------------------
    def move_to_arm(self, request, response):
        pose_type = request.pose_type
        self.get_logger().info(f"Arm 자세변경 요청: pose_type={pose_type}")

        try:
            self.busy = True
            if pose_type == "cart_view":
                self._send_coords([28.4, -78.5, 321.6, -151.79, -10.16, -98.4], self.speed)
            else:
                self._send_angles([0, 0, 0, 0, 0, 0], self.speed)
            time.sleep(1)

            response.success = True
            response.message = "자세변경 완료"
        except Exception as e:
            self.get_logger().error(f"자세변경 실패: {e}")
            response.success = False
            response.message = f"자세변경 실패: {e}"
        finally:
            self.busy = False
        return response

    # -------------------- 서비스: 픽업 --------------------
    def pickup_product(self, request, response):
        robot_id = request.robot_id
        order_id = request.order_id
        product_id = request.product_id

        self.get_logger().info(f"상품 픽업 요청: product_id={product_id}")

        try:
            self.busy = True

            # 카트 확인 자세로 이동 + 그리퍼 오픈
            self._send_coords([28.4, -78.5, 321.6, -151.79, -10.16, -98.4], self.speed)
            self._set_gripper_value(100, self.speed)
            self.get_logger().info("장바구니 확인 자세로 이동")
            time.sleep(1)

            while rclpy.ok():
                results = self.call_vision_service(robot_id, order_id, product_id)
                if results is None or not results.success:
                    self.get_logger().warn("비전 응답 실패 또는 미탐지 → 재시도 중...")
                    continue

                cur = np.array([
                    results.current_pose.x, results.current_pose.y, results.current_pose.z,
                    results.current_pose.rx, results.current_pose.ry, results.current_pose.rz
                ], dtype=float)
                tgt = np.array([
                    results.target_pose.x, results.target_pose.y, results.target_pose.z,
                    results.target_pose.rx, results.target_pose.ry, results.target_pose.rz
                ], dtype=float)

                # 단순 목표로 바로 이동 (필요 시 gain으로 점진 접근 가능)
                pose = tgt.copy()
                self.get_logger().info(f"Arm 이동: {pose.tolist()}")
                self._send_coords(pose.tolist(), self.speed)

                err = float(np.linalg.norm(tgt - pose))
                self.get_logger().info(f"pose error norm={err:.2f}")

                if err < self.epsilon:
                    self.get_logger().info("목표 포즈 도달 → 픽업 시작")

                    # Z-120mm 내려가 집기
                    lift_pose = pose.copy()
                    lift_pose[2] -= 120.0
                    self._send_coords(lift_pose.tolist(), self.speed)
                    time.sleep(1)

                    self._set_gripper_value(0, self.speed)
                    self.get_logger().info("그리퍼 닫음")
                    time.sleep(1)

                    # 홈 자세로 복귀
                    self._send_angles([0, 0, 0, 0, 0, 0], self.speed)
                    self.get_logger().info("상품 들어올림 완료")

                    response.success = True
                    response.message = f"{self.products.get(product_id, '상품')} 픽업 완료"
                    return response

        except Exception as e:
            self.get_logger().error(f"픽업 실패: {e}")
            response.success = False
            response.message = f"픽업 실패: {e}"
            return response
        finally:
            self.busy = False


def main():
    rclpy.init()
    node = PackeeArmController()

    executor = MultiThreadedExecutor(num_threads=4)
    executor.add_node(node)

    try:
        executor.spin()
    except KeyboardInterrupt:
        pass
    finally:
        node.destroy_node()
        rclpy.shutdown()


if __name__ == '__main__':
    main()
